<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wonnabe.nowme.mapper.NowMeMapper">

    <!-- ðŸ”¹ [SpendingEvaluator] ì†Œë¹„íŒ¨í„´ ì •ëŸ‰ í‰ê°€ìš© -->

    <!-- 1. ì „ì²´ ì†Œë¹„ ê¸ˆì•¡ (ìµœê·¼ 1ê°œì›”) -->
    <select id="getTotalSpending" resultType="double">
        SELECT COALESCE(SUM(amount), 0)
        FROM Card_Transactions
        WHERE user_id = #{userId}
          AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
    </select>

    <!-- 2. í•„ìˆ˜ì†Œë¹„ ì¹´í…Œê³ ë¦¬ í•©ê³„ (food, transport, living, fixcost) -->
    <select id="getSpendingByCategories" resultType="double">
        SELECT COALESCE(SUM(amount), 0)
        FROM Card_Transactions
        WHERE user_id = #{userId}
        AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
        AND merchant_category IN
        <foreach item="item" collection="categories" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <!-- 3. ì„ íƒì†Œë¹„ ì¹´í…Œê³ ë¦¬ ì¢…ë¥˜ ìˆ˜ (í•„ìˆ˜ì†Œë¹„ ì œì™¸) -->
    <select id="getMonthlySelectableCategoryCount" resultType="int">
        SELECT COUNT(DISTINCT merchant_category)
        FROM Card_Transactions
        WHERE user_id = #{userId}
          AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
          AND merchant_category NOT IN ('food', 'transport', 'living', 'fixcost')
    </select>

    <!-- 4. ì£¼ë³„ ì†Œë¹„ í‘œì¤€íŽ¸ì°¨ (ìµœê·¼ 1ê°œì›”) -->
    <select id="getWeeklySpendingStdDev" resultType="double">
        SELECT COALESCE(STDDEV(weekly_total), 0)
        FROM (
                 SELECT YEARWEEK(transaction_date) AS week_key,
                        SUM(amount) AS weekly_total
                 FROM Card_Transactions
                 WHERE user_id = #{userId}
                   AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                 GROUP BY week_key
             ) AS weekly_data
    </select>

    <!-- ðŸ”¹ [ActivityEvaluator] ê¸ˆìœµí™œë™ì„± ì •ëŸ‰ í‰ê°€ìš© -->

    <!-- 5. ê³„ì¢Œ ì¹´í…Œê³ ë¦¬ ìˆ˜ (ìž…ì¶œê¸ˆ, íˆ¬ìž, ì—°ê¸ˆ ë“± ì¢…ë¥˜) -->
    <select id="getAccountCategoryCount" resultType="int">
        SELECT COUNT(DISTINCT category)
        FROM User_Accounts
        WHERE user_id = #{userId}
    </select>

    <!-- 6. ì €ì¶•ìƒí’ˆ ê°€ìž… ìˆ˜ -->
    <select id="getSavingsProductCount" resultType="int">
        SELECT COUNT(*)
        FROM User_Savings
        WHERE user_id = #{userId}
    </select>

    <!-- 7. ë³´í—˜ìƒí’ˆ ê°€ìž… ìˆ˜ -->
    <select id="getInsuranceProductCount" resultType="int">
        SELECT COUNT(*)
        FROM User_Insurance
        WHERE user_id = #{userId}
    </select>

    <!-- 8. ìµœê·¼ 1ê°œì›” ê±°ëž˜ ê±´ìˆ˜ -->
    <select id="getMonthlyTransactionCount" resultType="int">
        SELECT COUNT(*)
        FROM Card_Transactions
        WHERE user_id = #{userId}
          AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
    </select>

    <!-- 9. ìµœê·¼ 1ê°œì›” ì†Œë¹„ì²˜ ë‹¤ì–‘ì„± (merchant_category ê¸°ì¤€) -->
    <select id="getMonthlyMerchantCategoryCount" resultType="int">
        SELECT COUNT(DISTINCT merchant_category)
        FROM Card_Transactions
        WHERE user_id = #{userId}
          AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
    </select>

    <!-- ðŸ”¹ [RiskEvaluator] ë¦¬ìŠ¤í¬ì„±í–¥ ì •ëŸ‰ í‰ê°€ìš© -->

    <!-- 10. ì „ì²´ ê³„ì¢Œ ìž”ì•¡ í•©ê³„ -->
    <select id="getTotalBalance" resultType="double">
        SELECT COALESCE(SUM(balance), 0)
        FROM User_Accounts
        WHERE user_id = #{userId}
    </select>

    <!-- 11. íŠ¹ì • ì¹´í…Œê³ ë¦¬ ê³„ì¢Œë“¤ì˜ ìž”ì•¡ í•©ê³„ (íˆ¬ìž, ì£¼ì‹, íŽ€ë“œ ë“±) -->
    <select id="getBalanceByCategories" resultType="double">
        SELECT COALESCE(SUM(balance), 0)
        FROM User_Accounts
        WHERE user_id = #{userId}
        AND category IN
        <foreach item="item" collection="categories" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <!-- 12. íŠ¹ì • ì¹´í…Œê³ ë¦¬ ê³„ì¢Œ ìˆ˜ (íˆ¬ìžìƒí’ˆ ë‹¤ì–‘ì„±ìš©) -->
    <select id="getAccountCountByCategories" resultType="int">
        SELECT COUNT(DISTINCT account_name)
        FROM User_Accounts
        WHERE user_id = #{userId}
        AND category IN
        <foreach item="item" collection="categories" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <!-- 13. ê°€ìž…í•œ ì €ì¶•ìƒí’ˆì˜ í‰ê·  max_rate (ê³ ê¸ˆë¦¬ ì„ í˜¸ ê²½í–¥) -->
    <select id="getAvgSavingsRate" resultType="double">
        SELECT COALESCE(AVG(sp.max_rate), 0)
        FROM User_Savings us
                 JOIN Savings_Product sp ON us.product_id = sp.product_id
        WHERE us.user_id = #{userId}
    </select>

    <!-- ðŸ”¹ [PlanningEvaluator] ê³„íšë°©ì‹ ì •ëŸ‰ í‰ê°€ìš© -->

    <!-- 16. ëª©í‘œ ê°œìˆ˜ -->
    <select id="getGoalCount" resultType="int">
        SELECT COUNT(*)
        FROM user_goal
        WHERE user_id = #{userId}
          AND status = 'PUBLISHED'
    </select>

    <!-- 17. í‰ê·  ëª©í‘œ ì§„ì²™ë¥  (progress_rate í‰ê· ) -->
    <select id="getAverageGoalProgressRate" resultType="double">
        SELECT COALESCE(AVG(progress_rate), 0)
        FROM user_goal
        WHERE user_id = #{userId}
          AND status = 'PUBLISHED'
    </select>

    <!-- 18. ê³„íšëœ ì›” ì €ì¶• ê¸ˆì•¡ í•©ê³„ (ëª©í‘œ ê¸°ì¤€) -->
    <select id="getPlannedMonthlySaving" resultType="double">
        SELECT COALESCE(SUM(monthly_save_amount), 0)
        FROM user_goal
        WHERE user_id = #{userId}
          AND status = 'PUBLISHED'
          AND monthly_save_amount > 0
    </select>

    <!-- 19. ì‹¤ì œ ì›” ì €ì¶• ê¸ˆì•¡ í•©ê³„ (User_Savings ê¸°ì¤€) -->
    <select id="getActualMonthlySaving" resultType="double">
        SELECT COALESCE(SUM(monthly_payment), 0)
        FROM User_Savings
        WHERE user_id = #{userId}
          AND monthly_payment > 0
    </select>

    <!-- 20. ì›”ë³„ ì†Œë¹„ í‘œì¤€íŽ¸ì°¨ (ìµœê·¼ 6ê°œì›”, Summaries_Cache í™œìš©) -->
    <select id="getMonthlySpendingStdDev" resultType="double">
        SELECT COALESCE(STDDEV(monthly_total), 0)
        FROM (
                 SELECT SUM(amount) AS monthly_total
                 FROM Summaries_Cache
                 WHERE user_id = #{userId}
                   AND period_type = 'monthly'
                   AND date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
                 GROUP BY yearMonth
             ) AS monthly_data
    </select>

    <!-- 21. ì›”ë³„ ì†Œë¹„ í‰ê·  (ìµœê·¼ 6ê°œì›”, Summaries_Cache í™œìš©) -->
    <select id="getMonthlySpendingAverage" resultType="double">
        SELECT COALESCE(AVG(monthly_total), 0)
        FROM (
                 SELECT SUM(amount) AS monthly_total
                 FROM Summaries_Cache
                 WHERE user_id = #{userId}
                   AND period_type = 'monthly'
                   AND date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
                 GROUP BY yearMonth
             ) AS monthly_data
    </select>

    <!-- ðŸ”¹ [ê³µí†µ ì •ë³´] -->

    <!-- 14. ì‚¬ìš©ìž ê°€êµ¬ì› ìˆ˜ -->
    <select id="getHouseholdSize" resultType="int">
        SELECT COALESCE(household_size, 1)
        FROM User_Info
        WHERE user_id = #{userId}
    </select>

    <!-- 15. ì—°ì†Œë“ -->
    <select id="getAnnualIncome" resultType="double">
        SELECT COALESCE(income_annual_amount, 0)
        FROM User_Info
        WHERE user_id = #{userId}
    </select>

    <!-- ðŸ”¹ [ì§„ë‹¨ ê²°ê³¼ ì €ìž¥ìš©] - ì£¼ì„ ì²˜ë¦¬ (í–¥í›„ í™•ìž¥) -->

    <!--
    <insert id="insertDiagnosisHistory" parameterType="com.wonnabe.nowme.domain.DiagnosisHistory">
        INSERT INTO Diagnosis_History (user_id, persona_name, similarity, diagnosed_at)
        VALUES (#{userId}, #{personaName}, #{similarity}, #{diagnosedAt})
    </insert>
    -->

</mapper>