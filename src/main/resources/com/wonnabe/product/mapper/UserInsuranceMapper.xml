<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wonnabe.product.mapper.UserInsuranceMapper">

    <resultMap id="userInsuranceResultMap" type="com.wonnabe.product.domain.UserInsuranceVO">
        <id property="id" column="ui_id"/>
        <result property="userId" column="ui_user_id"/>
        <result property="productId" column="ui_product_id"/>
        <result property="monthlyPremium" column="ui_monthly_premium"/>
        <result property="startDate" column="ui_start_date"/>
        <result property="endDate" column="ui_end_date"/>
        <result property="totalPaid" column="ui_total_paid"/>
        <result property="createdAt" column="ui_created_at"/>
        <association property="product" javaType="com.wonnabe.product.domain.InsuranceProductVO">
            <id property="productId" column="p_product_id"/>
            <result property="providerName" column="p_provider_name"/>
            <result property="productName" column="p_product_name"/>
            <result property="coverageType" column="p_coverage_type"/>
            <result property="coverageDesc" column="p_coverage_desc"/>
            <result property="coverageLimit" column="p_coverage_limit"/>
        </association>
    </resultMap>

    <resultMap id="insuranceProductResultMap" type="com.wonnabe.product.domain.InsuranceProductVO">
        <id property="productId" column="product_id"/>
        <result property="providerName" column="provider_name"/>
        <result property="productName" column="product_name"/>
        <result property="minAge" column="min_age"/>
        <result property="maxAge" column="max_age"/>
        <result property="femalePremium" column="female_premium"/>
        <result property="malePremium" column="male_premium"/>
        <result property="scorePriceCompetitiveness" column="score_price_competitiveness"/>
        <result property="scoreCoverageLimit" column="score_coverage_limit"/>
        <result property="scoreCoverageScope" column="score_coverage_scope"/>
        <result property="scoreDeductibleLevel" column="score_deductible_level"/>
        <result property="scoreRefundScope" column="score_refund_scope"/>
        <result property="coverageType" column="coverage_type"/>
        <result property="coverageLimit" column="coverage_limit"/>
        <result property="myMoney" column="my_money"/>
        <result property="coverageDesc" column="coverage_desc"/>
        <result property="note" column="note"/>
    </resultMap>

    <!-- 사용자의 특정 보험 상품에 대한 가입 상세 정보를 조회하는 쿼리 -->
    <select id="findDetailByProductId" resultMap="userInsuranceResultMap">
        SELECT
            ui.id AS ui_id,
            ui.user_id AS ui_user_id,
            ui.product_id AS ui_product_id,
            ui.monthly_premium AS ui_monthly_premium,
            ui.start_date AS ui_start_date,
            ui.end_date AS ui_end_date,
            ui.total_paid AS ui_total_paid,
            ui.created_at AS ui_created_at,

            p.product_id AS p_product_id,
            p.provider_name AS p_provider_name,
            p.product_name AS p_product_name,
            p.coverage_type AS p_coverage_type,
            p.coverage_desc AS p_coverage_desc,
            p.coverage_limit AS p_coverage_limit
        FROM
            user_insurance ui
        JOIN
            insurance_product p ON ui.product_id = p.product_id
        WHERE
            ui.user_id = #{userId} AND ui.product_id = #{productId}
    </select>

    <!-- Transaction에서 userId랑 Category로 가져오는 것 -->
    <select id="findMonthlyTransactionSums" resultType="com.wonnabe.product.dto.TransactionSummaryDto">
        SELECT
            DATE_FORMAT(transaction_date, '%Y-%m') as month,
            SUM(amount) as totalSavings
        FROM
            User_Transactions
        WHERE
            user_id = #{userId}
          AND asset_category = '보험'
          AND transaction_date >= #{startDate}
        GROUP BY
            month
        ORDER BY
            month ASC
    </select>

    <select id="findAllByUserId" resultType="com.wonnabe.product.domain.UserInsuranceVO">
        SELECT * FROM User_Insurance WHERE user_id = #{userId}
    </select>

    <!-- 특정 상품 ID로 보험 상품 상세 정보를 조회하는 쿼리 -->
    <select id="findInsuranceProductById" resultMap="insuranceProductResultMap">
        SELECT
            product_id,
            provider_name,
            product_name,
            min_age,
            max_age,
            female_premium,
            male_premium,
            score_price_competitiveness,
            score_coverage_limit,
            score_coverage_scope,
            score_deductible_level,
            score_refund_scope,
            coverage_type,
            coverage_limit,
            my_money,
            coverage_desc,
            note
        FROM
            insurance_product
        WHERE
            product_id = #{productId}
    </select>

    <!-- 특정 사용자의 특정 보험 상품에 대한 총 수령액(입금)을 조회하는 쿼리 -->
    <select id="findTotalReceiptAmount" resultType="java.lang.Long">
        SELECT
            COALESCE(SUM(amount), 0)
        FROM
            User_Transactions
        WHERE
            user_id = #{userId}
            AND product_id = #{productId}
            AND asset_category = '보험'
            AND transaction_type = '입금'
    </select>

    <!-- 특정 사용자의 특정 보험 상품에 대한 총 납입액(출금)을 조회하는 쿼리 -->
    <select id="findTotalPaymentAmount" resultType="java.lang.Long">
        SELECT
            COALESCE(SUM(amount), 0)
        FROM
            User_Transactions
        WHERE
            user_id = #{userId}
            AND product_id = #{productId}
            AND asset_category = '보험'
            AND transaction_type = '출금'
    </select>

    <!-- 특정 사용자의 특정 보험 상품에 대한 월별 수령액(입금)을 조회하는 쿼리 -->
    <select id="findMonthlyInsuranceReceipts" resultType="com.wonnabe.product.dto.MonthlyInsuranceReceiptDto">
        SELECT
            DATE_FORMAT(transaction_date, '%Y-%m') as month,
            COALESCE(SUM(amount), 0) as amount
        FROM
            User_Transactions
        WHERE
            user_id = #{userId}
            AND product_id = #{productId}
            AND asset_category = '보험'
            AND transaction_type = '입금'
            AND transaction_date >= #{startDate}
        GROUP BY
            month
        ORDER BY
            month ASC
    </select>

</mapper>

