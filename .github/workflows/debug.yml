name: Debug Server Status

on:
  workflow_dispatch: # 수동 실행용

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: 🔍 서버 상태 전체 점검
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "🔍 서버 전체 상태 점검 시작..."
            echo "========================================"
            
            echo "📋 시스템 정보:"
            uname -a
            whoami
            pwd
            
            echo "📋 Tomcat 관련 디렉토리 검색:"
            sudo find / -name "*tomcat*" -type d 2>/dev/null | head -20
            
            echo "📋 webapps 디렉토리 검색:"
            sudo find / -name "webapps" -type d 2>/dev/null
            
            echo "📋 Tomcat 프로세스:"
            ps aux | grep tomcat | grep -v grep || echo "Tomcat 프로세스 없음"
            
            echo "📋 systemctl 서비스 상태:"
            sudo systemctl status tomcat || echo "tomcat 서비스 없음"
            sudo systemctl status tomcat9 || echo "tomcat9 서비스 없음"
            sudo systemctl status tomcat8 || echo "tomcat8 서비스 없음"
            
            echo "📋 8080 포트 사용 현황:"
            sudo netstat -tulpn | grep :8080 || echo "8080 포트 사용 없음"
            
            echo "📋 Java 설치 확인:"
            java -version 2>&1 || echo "Java 없음"
            which java || echo "Java 경로 없음"
            
            echo "📋 현재 GitHub Secrets TOMCAT_PATH 확인:"
            echo "TOMCAT_PATH 설정값: ${{ secrets.TOMCAT_PATH }}"
            if [ -d "${{ secrets.TOMCAT_PATH }}" ]; then
              echo "✅ TOMCAT_PATH 디렉토리 존재"
              sudo ls -la "${{ secrets.TOMCAT_PATH }}/"
              if [ -d "${{ secrets.TOMCAT_PATH }}/webapps" ]; then
                echo "✅ webapps 디렉토리 존재"
                sudo ls -la "${{ secrets.TOMCAT_PATH }}/webapps/"
              else
                echo "❌ webapps 디렉토리 없음"
              fi
            else
              echo "❌ TOMCAT_PATH 디렉토리 없음"
            fi
            
            echo "📋 로그 파일 검색:"
            sudo find / -name "catalina.out" 2>/dev/null || echo "catalina.out 없음"
            sudo find / -name "*tomcat*log*" 2>/dev/null | head -10
            
            echo "📋 일반적인 Tomcat 경로들 확인:"
            for path in "/opt/tomcat" "/var/lib/tomcat9" "/usr/share/tomcat9" "/home/tomcat" "/opt/apache-tomcat"; do
              if [ -d "$path" ]; then
                echo "✅ $path 존재"
                sudo ls -la "$path/" | head -10
              else
                echo "❌ $path 없음"
              fi
            done
            
            echo "========================================"
            echo "🔍 서버 상태 점검 완료"