name: Spring Legacy CI/CD Pipeline

on:
  push:
    branches: [ main, feature/github-actions ]
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '17'
  WAR_NAME: 'wonnabe'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: â˜• JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ“¦ Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ”§ Gradle Wrapper ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test --no-daemon --continue || true
        continue-on-error: true

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            build/reports/tests/
            build/test-results/

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: â˜• JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ“¦ Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ”§ Gradle Wrapper ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: ğŸ—ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
        run: ./gradlew clean build war -x test --no-daemon

      - name: ğŸ“¤ WAR íŒŒì¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: war-file
          path: build/libs/*.war

  deploy:
    needs: [test, build-and-deploy]
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature/github-actions') && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ WAR íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: war-file
          path: ./

      - name: ğŸ”§ ì„œë²„ ì¤€ë¹„ ë° ë°±ì—…
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘: $(date)"
            
            # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p ${{ secrets.TOMCAT_PATH }}/backup
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë²„ì „ í™•ì¸ ë° ë°±ì—…
            if [ -f "${{ secrets.TOMCAT_PATH }}/webapps/ROOT.war" ]; then
              BACKUP_NAME="ROOT-$(date +%Y%m%d_%H%M%S).war"
              sudo cp "${{ secrets.TOMCAT_PATH }}/webapps/ROOT.war" \
                     "${{ secrets.TOMCAT_PATH }}/backup/$BACKUP_NAME"
              echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_NAME"
              echo "$BACKUP_NAME" > ~/last_backup.txt
            else
              echo "ğŸ“ ê¸°ì¡´ WAR íŒŒì¼ ì—†ìŒ"
              echo "none" > ~/last_backup.txt
            fi
            
            # Tomcat ì¤‘ì§€
            echo "ğŸ›‘ Tomcat ì¤‘ì§€..."
            sudo systemctl stop tomcat
            
            # ê¸°ì¡´ íŒŒì¼ ì œê±° (ROOT ì• í”Œë¦¬ì¼€ì´ì…˜)
            sudo rm -f "${{ secrets.TOMCAT_PATH }}/webapps/ROOT.war"
            sudo rm -rf "${{ secrets.TOMCAT_PATH }}/webapps/ROOT/"
            
            # ì„ì‹œ í´ë” ìƒì„±
            mkdir -p ~/deploy

      - name: ğŸ“¤ WAR íŒŒì¼ ì„œë²„ ì „ì†¡
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "*.war"
          target: "/home/${{ secrets.EC2_USERNAME }}/deploy/"

      - name: ğŸš€ ìƒˆ ë²„ì „ ë°°í¬
        id: deploy_new_version
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # WAR íŒŒì¼ì„ ROOTë¡œ ì´ë™
            sudo mv "/home/${{ secrets.EC2_USERNAME }}/deploy/"*.war \
                   "${{ secrets.TOMCAT_PATH }}/webapps/ROOT.war"
            
            # ê¶Œí•œ ì„¤ì •
            sudo chown tomcat:tomcat "${{ secrets.TOMCAT_PATH }}/webapps/ROOT.war"
            
            # Tomcat ì‹œì‘
            echo "ğŸš€ Tomcat ì‹œì‘..."
            sudo systemctl start tomcat
            
            # ì‹œì‘ í™•ì¸ (30ì´ˆ ëŒ€ê¸°)
            echo "â³ 30ì´ˆ ëŒ€ê¸° ì¤‘..."
            sleep 30
            
            if sudo systemctl is-active --quiet tomcat; then
              echo "âœ… Tomcat ì‹œì‘ ì„±ê³µ"
            else
              echo "âŒ Tomcat ì‹œì‘ ì‹¤íŒ¨"
              exit 1
            fi

      - name: ğŸ” í—¬ìŠ¤ì²´í¬ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‘ë™ í™•ì¸)
        id: health_check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ” í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
            
            # ìµœëŒ€ 5ë¶„ ë™ì•ˆ í—¬ìŠ¤ì²´í¬ ì‹œë„
            for i in {1..30}; do
              echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/30..."
            
              # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸ (8080 í¬íŠ¸) - ROOT ê²½ë¡œë¡œ í™•ì¸
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
            
              if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ]; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì„±ê³µ! (HTTP $HTTP_STATUS)"
                exit 0
              elif [ "$HTTP_STATUS" = "404" ]; then
                echo "ğŸ“ 404 ì‘ë‹µ - ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì•„ì§ ì™„ì „íˆ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŒ"
              else
                echo "âš ï¸ HTTP ìƒíƒœ: $HTTP_STATUS"
              fi
            
              sleep 10
            done
            
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - 5ë¶„ ë‚´ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒ ì‘ë‹µí•˜ì§€ ì•ŠìŒ"
            exit 1

      - name: ğŸ”„ ë¡¤ë°± (ë°°í¬ ì‹¤íŒ¨ ì‹œ)
        if: failure() && (steps.deploy_new_version.outcome == 'failure' || steps.health_check.outcome == 'failure')
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ”„ ë¡¤ë°± ì‹œì‘..."
            
            # Tomcat ì¤‘ì§€
            sudo systemctl stop tomcat
            
            # í˜„ì¬ WAR íŒŒì¼ ì œê±°
            sudo rm -f "${{ secrets.TOMCAT_PATH }}/webapps/ROOT.war"
            sudo rm -rf "${{ secrets.TOMCAT_PATH }}/webapps/ROOT/"
            
            # ë°±ì—… íŒŒì¼ ë³µì›
            BACKUP_FILE=$(cat ~/last_backup.txt)
            if [ "$BACKUP_FILE" != "none" ] && [ -f "${{ secrets.TOMCAT_PATH }}/backup/$BACKUP_FILE" ]; then
              sudo cp "${{ secrets.TOMCAT_PATH }}/backup/$BACKUP_FILE" \
                     "${{ secrets.TOMCAT_PATH }}/webapps/ROOT.war"
              sudo chown tomcat:tomcat "${{ secrets.TOMCAT_PATH }}/webapps/ROOT.war"
              echo "âœ… ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°± ì™„ë£Œ: $BACKUP_FILE"
            else
              echo "ğŸ“ ë¡¤ë°±í•  ì´ì „ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤"
            fi
            
            # Tomcat ì¬ì‹œì‘
            sudo systemctl start tomcat
            sleep 15
            
            if sudo systemctl is-active --quiet tomcat; then
              echo "âœ… ë¡¤ë°± í›„ Tomcat ì •ìƒ ì‹¤í–‰"
            else
              echo "âŒ ë¡¤ë°± í›„ì—ë„ Tomcat ì‹¤í–‰ ì‹¤íŒ¨"
            fi

      - name: ğŸ§¹ ì •ë¦¬ ì‘ì—…
        if: always()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf "/home/${{ secrets.EC2_USERNAME }}/deploy"
            rm -f ~/last_backup.txt
            
            # ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (7ì¼ ì´ìƒëœ ê²ƒë“¤)
            find "${{ secrets.TOMCAT_PATH }}/backup" -name "ROOT-*.war" -mtime +7 -delete 2>/dev/null || true
            
            echo "ğŸ§¹ ì •ë¦¬ ì™„ë£Œ"

      - name: ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ ì „ì†¡
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ job.status == 'success' && 'âœ… ë°°í¬ ì„±ê³µ' || 'ğŸš¨ ë°°í¬ ì‹¤íŒ¨' }} - ${{ github.repository }}
          body: |
            ğŸš€ CI/CD ë°°í¬ ê²°ê³¼ ì•Œë¦¼
            
            ğŸ“Š ë°°í¬ ê²°ê³¼: ${{ job.status }}
            ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}
            ğŸ“ ì»¤ë°‹: ${{ github.sha }}
            ğŸ‘¤ ë°°í¬ì: ${{ github.actor }}
            ğŸ“… ì‹œê°„: $(date)
            
            ğŸ”— ìƒì„¸ ë¡œê·¸ í™•ì¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ${{ job.status == 'success' && 'âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!' || 'âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìë™ ë¡¤ë°±ì´ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.' }}
          to: starr075@gmail.com
          from: Wonnabe CI/CD Bot <noreply@wonnabe.com>

      - name: ğŸ‰ ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
          echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "ğŸ‘¤ ë°°í¬ì: ${{ github.actor }}"

      - name: ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨!"
          echo "ğŸ“… ì‹¤íŒ¨ ì‹œê°„: $(date)"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "ğŸ‘¤ ì‹œë„ì: ${{ github.actor }}"
          echo "ğŸ”„ ë¡¤ë°±ì´ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."